<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/beige.css">
        <link rel="stylesheet" href="css/sli.css">
        <meta charset="utf-8"/>
    <script>
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    </head>
        <body>
    <div class="reveal">
        <div class="slides">
          <section>
            <h1>SQL Intermediate</h1>
            <p>Stefan Litsche</p>
            <p>21.06.2023</p>
            <aside class="notes">
              <p>By the end the training</p>
              <ul>
                <li>write analytical queries</li>
                <li>using aggregate fn with groups and window fn</li>
              </ul>
            </aside>
          </section>
            <section data-transition="slide">
              <section>
                <!--h2>Setup</h2-->
                <img src="SQL-valuable.png"/>
              </section>

            <section>
                <h3>Sample dataset</h3>
                <ul>
                <li>customers</li>
                <li>orders</li>
                <li>orderlines</li>
                </ul>
                <aside class="notes">

                </aside>
            </section>
            </section>

            <section data-transition="slide">

              <section>
                <!-- https://www.flickr.com/photos/csumner/3033385360/in/photolist-5C3TMA-bD8jAm-4QYK2e-55hRet-9s2K9c-peCwBu-22ZnM1k-72eiDc-JfVrhh-8EdfNw-Cf1xx-2GsgH6-665h4w-arTmQU-dZy9Un-dr1VG4-4ot9D5-bQpXT-DhU18y-5vDqDP-diS3bf-4nEUuC-5y95xY-iYU5oh-oVqyhx-9vV7U-5m22hW-93BgnE-9nd1xA-49SSkg-5h7AEA-igzZPD-bEwS6Y-49SRwF-pV29as-5fZHAW-5vDoKx-8VQYZF-59Ko18-bCp3Bw-pCzsHP-diS1A9-bCoSd1-ipmhdR-oPMx-iskTFu-gCKS3-8hu15H-6Zswp5-8TYhbf
https://www.flickr.com/photos/csumner/
bookshelf.jpg-->
                <h2>Grouping sets</h2>
                <img data-src="alexilie_books2.jpg"/>
              </section>

                <section>
                  <h3>Group By</h3>
                  <div class="sli">
                  <pre><code data-noescape >
    SELECT <span class="fragment highlight-current-blue">country</span>,
           <span class="fragment highlight-current-blue">count(*)</span>
      FROM customers
     GROUP BY <span data-fragment-index="0" class="fragment highlight-blue">country</span>;
                  </code></pre>
                  <pre><code>
   country    │ count
──────────────┼───────────
 France       │       971
 China        │      1002
 Australia    │      1034
 UK           │      1002
 US           │     10000
 Germany      │      1004
 Canada       │      1004
 Chile        │      1047
 South Africa │       935
 Japan        │       989
 Russia       │      1012
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <ul>
                      <li>List of Grouping columns</li>
                      <li>Aggregate function</li>
                      <li>On Result of <b>WHERE</b></li>
                    </ul>
                  </aside>
                </section>

                <section>
                  <h3>Ordered groups</h3>
                  <div class="sli">
                  <pre><code data-noescape >
    SELECT country AS realm,
           count(*) AS customers
      FROM customers
     GROUP BY <span class="emphasize">realm</span>
     ORDER BY <span class="emphasize">customers</span> DESC;
                  </code></pre>
                  <pre><code>
    realm     │ customers
──────────────┼───────────
 US           │     10000
 Chile        │      1047
 Australia    │      1034
 Russia       │      1012
 Germany      │      1004
 Canada       │      1004
 China        │      1002
 UK           │      1002
 Japan        │       989
 France       │       971
 South Africa │       935
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <p>Refer to alias</p>
                    <ul>
                      <li>in group by</li>
                      <li>in order by</li>
                    </ul>
                    <p>positional possible with drawbacks</p>
                  </aside>
                </section>

                <section>
                  <h3>Conditional aggregation</h3>
                  <div>
                  <pre><code data-noescape >
     SELECT country,
            count(*)                     AS row_count,
            count(o.orderid)             AS orders,
            count(distinct c.customerid) AS customers,
            count(distinct o.customerid) AS active
       FROM customers c
  LEFT JOIN orders o ON c.customerid = o.customerid
      GROUP BY country;
                  </code></pre>
                  <pre><code>
   country    │ row_count │ orders │ customers │ active
──────────────┼───────────┼────────┼───────────┼───────
 Australia    │      1197 │    639 │      1034 │    476
 Canada       │      1178 │    649 │      1004 │    475
 Chile        │      1217 │    630 │      1047 │    460
 China        │      1147 │    609 │      1002 │    464
 France       │      1130 │    636 │       971 │    477
 Germany      │      1150 │    579 │      1004 │    433
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <p>Which SQL syntax for condition are known</p>
                    <p>How does <code>count(*)</code> change for FULL JOIN or INNER JOIN?</p>
                  </aside>
                </section>

                <section>
                  <h3>Condition and filter</h3>
                  <div class="sli">
                  <pre><code data-noescape >
 SELECT
  country,
  count(distinct o.customerid) AS active,
  count(distinct c.customerid)
     <span class="emphasize">FILTER</span>
      (<span class="emphasize">WHERE</span> o.orderid is null) AS inactive
   FROM customers c
   LEFT JOIN orders o
          on o.customerid = c.customerid
  GROUP BY country;
                  </code></pre>
                  <pre><code>
   country    │ active │ inactive
──────────────┼────────┼──────────
 Australia    │    476 │      558
 Canada       │    475 │      529
 Chile        │    460 │      587
 China        │    464 │      538
 France       │    477 │      494
 Germany      │    433 │      571
                  </code></pre>
                  </div>
                  <aside class="notes"></aside>
                </section>

                <section>
                  <h3>Alternative to FILTER</h3>
                  <div class="sli">
                  <pre><code data-noescape >
 SELECT
  country,
  count(distinct o.customerid) AS active,
  count(distinct
        <span class="emphasize">CASE</span> WHEN o.orderid is null
             THEN c.customerid
        <span class="emphasize">END</span>) AS inactive
   FROM customers c
   LEFT JOIN orders o
          on o.customerid = c.customerid
  GROUP BY country;
                  </code></pre>
                  <pre><code>
   country    │ active │ inactive
──────────────┼────────┼──────────
 Australia    │    476 │      558
 Canada       │    475 │      529
 Chile        │    460 │      587
 China        │    464 │      538
 France       │    477 │      494
 Germany      │    433 │      571
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <p>Why could we remove the distinct before the case?</p>
                    <p>Why shouldn't we?</p>
                  </aside>
                </section>

                <section>
                  <p>Exercise: Compare customer count per country with
                    customer count whose last name
                    starts with 'A'.<br/>
                  Hint: <code>lastname like 'A%'</code></p>
                  <div class="fragment sli">
                  <pre><code data-noescape >
SELECT country,
       count(*) as customers,
       count(*)
FILTER (
 WHERE substring(lastname FROM 1 FOR 1)='A'
       ) AS withA
  FROM customers
 GROUP BY country;
                  </code></pre>
                  <pre><code>
   country    │ customers │ witha
──────────────┼───────────┼───────
 Australia    │      1034 │    41
 Canada       │      1004 │    21
 Chile        │      1047 │    35
 China        │      1002 │    43
 France       │       971 │    39
 Germany      │      1004 │    40
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <p>Next: Calculate the ratio and sort descending</p>
                  </aside>
                </section>

                <section>
                  <h3>Aggregates with order</h3>
                  <div class="fragment sli">
                  <pre><code data-noescape >
SELECT country,
       <span class="emphasize">mode()
         within group (order by prod_id)</span>
         AS top_product
  FROM customers c
  LEFT JOIN orders AS o
         ON c.customerid = o.customerid
       JOIN orderlines AS l
         ON l.orderid = o.orderid
      GROUP BY country
                  </code></pre>
                  <pre><code>
   country    │ top_product
──────────────┼─────────────
 Australia    │        4516
 Canada       │        3706
 Chile        │        7624
 China        │        7265
 France       │          47
 Germany      │        3177
                  </code></pre>
                  </div>
                  <aside class="notes">
                    <p><em>ordered set aggregate function</em> require ordering</p>
                    <p>top seller per country</p>
                  </aside>
                </section>

              <section>

                <h3>Aggregate Functions</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT
    array_agg(zip)
  FROM (
    SELECT zip FROM customers
     LIMIT 10) AS a;
                  </code></pre>
                  <pre><code>
            array_agg
---------------------------------
 {24101,11802,96082,78442,16291}
(1 row)
                  </code></pre>
                  </div>
                <aside class="notes">
                </aside>
              </section>

              <section>

                <h3>Aggregate Functions with order</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT
    array_agg(zip <span class="emphasize">ORDER BY zip</span>)
  FROM (
    SELECT zip FROM customers
     LIMIT 5) AS a;
                  </code></pre>
                  <pre><code>
            array_agg
---------------------------------
 {11802,16291,24101,78442,96082}
(1 row)
                  </code></pre>
                  </div>
                <aside class="notes">
                </aside>
              </section>
            </section>

            <section data-transition="slide">
              <section>
                <h2>Multiple groups</h2>
              </section>

              <section>
                <h3>Sample data</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT * FROM s;
                  </code></pre>
                  <pre><code>
 a │ b
───┼───
 1 │ 1
 1 │ 2
 2 │ 1
 2 │ 2
 3 │ 1
 3 │ 2
                  </code></pre>
                  </div>
                  <aside class="notes"></aside>
              </section>

              <section>
                <h3>Simple group</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT a, b, count(*)
  FROM s
 GROUP BY a,b;
                  </code></pre>
                  <pre><code>
 a │ b │ count
───┼───┼───────
 1 │ 1 │     1
 1 │ 2 │     1
 2 │ 1 │     1
 2 │ 2 │     1
 3 │ 1 │     1
 3 │ 2 │     1
                  </code></pre>
                  </div>
                <aside class="notes">
                  <p>Grand total?</p>
                </aside>
              </section>

               <section>
                <h3>Union of Group</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT a, b, count(*)
  FROM s
 GROUP BY a,b
UNION ALL
SELECT null, null, count(*)
  FROM s;
                  </code></pre>
                  <pre><code>
 a | b | count
---+---+-------
 1 | 1 |     1
 2 | 2 |     1
 3 | 1 |     1
 3 | 2 |     1
 1 | 2 |     1
 2 | 1 |     1
   |   |     6
                  </code></pre>
                  </div>
                <aside class="notes">
                  <p>Expensive, because of two tables scans</p>
                </aside>
              </section>

             <section>
                <h3>Multiple sets</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT a,b,count(*)
  FROM s
 GROUP BY <span class="emphasize">GROUPING SETS</span>
       (
          (a,b),
          ()
       );
                  </code></pre>
                  <pre><code>
 a │ b │ count
───┼───┼───────
 1 │ 1 │     1
 1 │ 2 │     1
 2 │ 1 │     1
 2 │ 2 │     1
 3 │ 1 │     1
 3 │ 2 │     1
   │   │     6
                  </code></pre>
                  </div>
                <aside class="notes">
                </aside>
              </section>

              <section>
                <h3>More sets</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT a,b,count(*)
  FROM s
 GROUP BY GROUPING SETS
       (
          (a,b),
          a,
          b,
          ()
       );
                  </code></pre>
                  <pre><code>
 a │ b │ count
───┼───┼───────
 1 │ 1 │     1
 1 │ 2 │     1
 1 │   │     2
 2 │ 1 │     1
 2 │ 2 │     1
 2 │   │     2
 3 │ 1 │     1
 3 │ 2 │     1
 3 │   │     2
   │ 1 │     3
   │ 2 │     3
   │   │     6
                  </code></pre>
                  </div>
                <aside class="notes">
                </aside>
              </section>

              <section>
                <p>Exercise: List the count of customers by country and state
                  and additional the count by country; ordered by country</p>
                <div class="fragment sli">
                <pre><code data-noescape >
SELECT country,
  CASE
    WHEN <span class="emphasize">GROUPING(state)</span> = 0
    THEN COALESCE(state, 'n/a')
    ELSE state
  END AS state,
  count(*) AS aggregate
  FROM customers
 GROUP BY GROUPING SETS (
    (country, state),
    country
 )
 ORDER BY country;
                  </code></pre>
                  </div>
                <aside class="notes">
                  <p>We get duplicates for Canada, since all states are
                    null.</p>
                  <p>This can be avoided by using <em>distinct</em>.</p>
                  <p>If we want to show null values, use GROUPING to change the label.</p>
                </aside>
              </section>
            </section>

            <section data-transition="slide">
              <section>

                <h2>Filter of groups</h2>
                <img data-src="juhansonin_shelf-color.jpg"/>
                <aside class="notes">
                  Filter Groups
                </aside>
              </section>

              <section>
                <h3>SELECT Syntax</h3>
                <div class="sli">
                <pre><code data-noescape >
SELECT
    [projection]
    [ FROM from_item [, ...] ]
    [ WHERE where_condition ]
    [ GROUP BY grouping_element [, ...] ]
    [ <span class="emphasize">HAVING</span> condition [, ...] ]
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>Where filters rows</li>
                    <li>filtered rows are grouped</li>
                    <li>groups are filtered by having</li>
                  </ul>
                  <p>What in <em>condition</em>?</p>
                  <ul>
                    <li>grouped column</li>
                    <li>aggregate function</li>
                  </ul>
                </aside>
              </section>

              <section>
                <h3>Example Having</h3>
                <div class="sli">
                <pre><code data-noescape >
  SELECT country,
         count(*)
    FROM customers
   GROUP BY country
  <span class="emphasize">HAVING count(*) > 1000</span>;
                  </code></pre>
                <pre><code data-noescape >
  country  │ count
───────────┼───────
 Australia │  1034
 Canada    │  1004
 Chile     │  1047
 China     │  1002
 Germany   │  1004
 Russia    │  1012
 UK        │  1002
 US        │ 10000
                </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>Where filters rows</li>
                    <li>filtered rows are grouped</li>
                    <li>groups are filtered by having</li>
                  </ul>
                  <p>What in <em>condition</em>?</p>
                  <ul>
                    <li>grouped column</li>
                    <li>aggregate function</li>
                  </ul>
                </aside>
              </section>

              <section>
                <p>Exercise: List all weeks with at most 220 orders (per week)
                  and a netamount of at least 42000 units. <br/>
                  Hint: <code>date_trunc('week', orderdate)</code></p>
                <div class="fragment sli">
                <pre><code data-noescape >
SELECT
  date_trunc('week', orderdate)
    AS week,
  count(*),
  sum(netamount)
   FROM orders
  GROUP BY 1
 HAVING count(*) <= 220
    and sum(netamount) >= 42000;
                  </code></pre>
                <pre><code data-noescape >
       week             │ count │   sum
────────────────────────┼───────┼──────────
 2004-11-15 00:00:00+00 │   219 │ 44050.54
 2004-05-31 00:00:00+00 │   217 │ 42146.54
 2004-12-06 00:00:00+00 │   218 │ 44321.58
 2004-10-04 00:00:00+00 │   207 │ 42963.59
 2004-03-15 00:00:00+00 │   219 │ 42164.14
 2004-02-09 00:00:00+00 │   219 │ 43414.81
 2004-06-14 00:00:00+00 │   205 │ 42098.08
 2004-08-30 00:00:00+00 │   218 │ 43858.71
                </code></pre>
                </div>
                <aside class="notes"></aside>
              </section>
            </section>

            <section data-transition="slide">
              <section>
                <!-- https://www.pexels.com/photo/architectural-design-architecture-building-business-454499/
no attributition required  window1.jpg
https://www.flickr.com/photos/islandjoe/ window-triple.jpg
-->
                <h2>Window Functions</h2>
                <img data-src="window-triple.jpg"/>
                <!--div class="attributition">https://www.flickr.com/photos/islandjoe/</div-->
                <aside class="notes">
                  Kudos Bruce Momjian
                </aside>
              </section>

              <section>
                <div>
                  <h3>What is a window function?</h3>
                  <ul>
                    <li>aggregate function across set of rows</li>
                    <li>without grouping rows</li>
                    <li>rows retain identity</li>
                  </ul>
                </div>
              </section>

              <section>
                <h3>Average order value</h3>
                <div class="">
                    <pre><code>
SELECT
 orderdate,
 DATE_TRUNC('week', orderdate),
 netamount,
 <span class="emphasize">AVG(netamount) OVER ()</span>
  FROM orders
 LIMIT 5;
                    </code>
                    </pre>
                    <pre><code>
 orderdate  | week        | netamount |   avg
------------+-------------+-----------+--------
 2004-01-27 | 2004-01-26  |    313.24 | 197.64
 2004-01-01 | 2003-12-29  |     54.90 | 197.64
 2004-01-17 | 2004-01-12  |    160.10 | 197.64
 2004-01-28 | 2004-01-26  |    106.67 | 197.64
 2004-01-09 | 2004-01-05  |    256.00 | 197.64
                     </code>
                    </pre>

                </div>
              </section>

              <section>
                <p>List the first 10 customerids and the total count of customers</p>
                <div class="fragment sli">
                  <pre><code data-noescape>
SELECT customerid, count(*) OVER()
  FROM customers
 ORDER BY customerid
 LIMIT 10;
                  </code></pre>
                </div>
              </section>

              <section>
                <h3>Weekly Average order value</h3>
                <div class="">
                    <pre><code>
SELECT
 orderdate, DATE_TRUNC('week', orderdate),
 netamount, AVG(netamount)
   OVER (<span class="fragment highlight-current-blue">PARTITION BY</span>
         <span class="fragment highlight-current-blue">DATE_TRUNC('week', orderdate)</span>)
  FROM orders
 LIMIT 10;
                    </code>
                    </pre>
                    <pre><code>
 orderdate  | week        | netamount |   avg
------------+-------------+-----------+--------
 2004-01-03 | 2003-12-29  |    384.20 | 186.76
 2004-01-04 | 2003-12-29  |     10.45 | 186.76
 2004-01-03 | 2003-12-29  |    235.31 | 186.76
 2004-01-01 | 2003-12-29  |     48.50 | 186.76
 2004-01-02 | 2003-12-29  |     71.31 | 186.76
 2004-01-06 | 2004-01-05  |    290.16 | 216.95
 2004-01-07 | 2004-01-05  |     46.32 | 216.95
 2004-01-10 | 2004-01-05  |    151.17 | 216.95
 2004-01-11 | 2004-01-05  |    267.29 | 216.95
 2004-01-06 | 2004-01-05  |     93.37 | 216.95
                     </code>
                    </pre>

                <aside class="notes">Mind the partition change</aside>
                </div>
              </section>

            <section>
              <p>Exercise: List the first 10 customerids, the country and the
                count for customers per country. </p>
                <div class="fragment">
                  <pre><code data-noescape>
SELECT customerid,  country, count(*) OVER(PARTITION BY country)
  FROM customers
 ORDER BY customerid
 LIMIT 10;
                  </code></pre>
                  <pre><code>
 customerid | country | count
------------+---------+-------
          1 | US      | 10000
          2 | US      | 10000
          3 | US      | 10000
          4 | US      | 10000
          5 | US      | 10000
          6 | US      | 10000
          7 | US      | 10000
          8 | US      | 10000
          9 | US      | 10000
         10 | US      | 10000
                  </code></pre>
                </div>
                <aside class="notes">
                  What happens to the count if we add a WHERE clause?
                </aside>
              </section>

              <section>
                <h3>Ordered Weekly Average order value</h3>
                <div class="">
                    <pre><code>
SELECT
 orderdate, date_trunc('week', orderdate),
 netamount, avg(netamount)
   OVER (PARTITION BY date_trunc('week', orderdate)
         <span class="emphasize">ORDER BY orderdate</span>)
  FROM orders
 LIMIT 10;
                    </code>
                    </pre>
                    <pre><code>
 orderdate  | week        | netamount |   avg
------------+-------------+-----------+--------
 2004-01-01 | 2003-12-29  |    361.87 | 138.37
 2004-01-01 | 2003-12-29  |    140.47 | 138.37
 2004-01-01 | 2003-12-29  |    313.55 | 138.37
 2004-01-01 | 2003-12-29  |     58.92 | 138.37
 2004-01-01 | 2003-12-29  |    209.14 | 138.37
 2004-01-02 | 2003-12-29  |     45.10 | 152.57
 2004-01-02 | 2003-12-29  |    227.24 | 152.57
 2004-01-02 | 2003-12-29  |    183.09 | 152.57
 2004-01-02 | 2003-12-29  |    142.47 | 152.57
 2004-01-02 | 2003-12-29  |    131.74 | 152.57
                     </code>
                    </pre>

                </div>
              </section>

            </section>

            <section>
              <section>
                <!-- https://www.flickr.com/photos/enricomatteucci/
                 data-background="window2.jpg"
https://www.flickr.com/photos/enricomatteucci/6977528665/in/photolist-bCzEbn-bYYz6m-cp5usy-WDzKi-Y54w7-G1e9am-UNAkQJ-P6EqtY-XwzpJT-c7kRdo-9EdBUH-6MXcS9-q8BwjF-24q7hAU-3PtK2W-77DzZ6-4BfYdV-fLUQJU-5DzmdC-GvJUaT-4NNaza-7UAPT4-D3stns-8gkjqc-77vap1-eghMnb-6Ua3jj-YKPpQg-GiY1X2-Hiy5se-e9rhv9-Dsqh3Z-8CczzY-2ei5Cr-tLWD-9SDB2y-dc4RjF-atcH7v-f5LnK7-hcbSNf-4m5s2Y-qmkLNw-6fHKmW-dhzTnA-fk1rac-9zDEKE-hdohht-djDZwj-dhzKmg-awBJ9E -->
                <h1 style="color: black">Window Syntax</h1>
              </section>

              <section>
                <h3>Window Clause</h3>
                <ul>
                  <li>Partition clause</li>
                  <li>Order by clause</li>
                  <li>Frame
                    <ul>
                      <li>Range</li>
                      <li>Rows</li>
                      <li>Groups</li>
                    </ul>
                  </li>
                </ul>
                <aside class="notes">
                  <ul>
                    <li>all optional</li>
                    <li>if framing is used, order is important.</li>
                    <li>window frames are constructed for every single input row separately</li>
                    <li><b>GROUPS</b> recently added to Postgres</li>
                  </ul>
                </aside>
              </section>

              <section>
                <h3>Window Syntax</h3>
                <div class="sli" style="flex-wrap: wrap;">
                  <pre><code>
   WINDOW (
     [PARTITION BY expression]
     [ORDER BY expression]
     [
       { RANGE | ROWS }
       { frame_start | BETWEEN frame_start AND frame_end }
     ]
   )
              </code></pre>
                </div>
                <div style="font-size:70%;">
                  <p><em>frame_start</em> and <em>frame_end</em> can be:</p>
                  <ul>
                    <li>UNBOUNDED PRECEDING</li>
                    <li><em>value</em> PRECEDING</li>
                    <li>CURRENT ROW</li>
                    <li><em>value</em> FOLLOWING</li>
                    <li>UNBOUNDED FOLLOWING</li>
                  </ul>
                </div>
                <aside class="notes">
                  <ul>
                    <li>brackets are optional</li>
                    <li>braces are selections</li>
                    <li>pipe split alternatives</li>
                    <li>unbounded preceding refers to start of partition</li>
                  </ul>
                </aside>
            </section>

              <section>
                <h3>Example data</h3>
                <div class="sli">
                    <pre><code>
SELECT * FROM c;
                    </code>
                    </pre>
                    <pre><code>
 a
────
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10                    </code>
                    </pre>

                </div>
              </section>

              <section>
                <h3>Simplest Example</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, <span class="emphasize">sum(a) OVER()</span> FROM c;
                  </code></pre>
                  <pre><code>
 a  │ sum
────┼─────
  1 │  55
  2 │  55
  3 │  55
  4 │  55
  5 │  55
  6 │  55
  7 │  55
  8 │  55
  9 │  55
 10 │  55
                  </code></pre>
                </div>
              </section>

              <section>
                <h3>Declare Windows</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER <span class="emphasize">w</span>,
          count(*) OVER <span class="emphasize">w</span>
  FROM c
<span class="emphasize">WINDOW w AS ()</span>;
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │  55 │    10
  2 │  55 │    10
  3 │  55 │    10
  4 │  55 │    10
  5 │  55 │    10
  6 │  55 │    10
  7 │  55 │    10
  8 │  55 │    10
  9 │  55 │    10
 10 │  55 │    10
                  </code></pre>
                </div>
              </section>

              <section>
                <h3>Frame Defaults</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">RANGE BETWEEN
               UNBOUNDED PRECEDING
               AND CURRENT ROW</span>);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │  55 │    10
  2 │  55 │    10
  3 │  55 │    10
  4 │  55 │    10
  5 │  55 │    10
  6 │  55 │    10
  7 │  55 │    10
  8 │  55 │    10
  9 │  55 │    10
 10 │  55 │    10
                  </code></pre>
                </div>
              </section>

            <section>
              <h2>Current Row</h2>
              <ul>
                <li>Literal row in ROWS mode</li>
                <li>First/last row with same ORDER BY value</li>
                <li>First/last row of the partition</li>
              </ul>
              <aside class="notes">
                In RANGE mode without Partition:

                Partition is the whole set.

                <p>frame_start: first <em>peer</em> row</p>
              </aside>
            </section>

            <section>
                <h3>Range is Default</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">RANGE</span> BETWEEN
               UNBOUNDED PRECEDING
               AND CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │  55 │    10
  2 │  55 │    10
  3 │  55 │    10
  4 │  55 │    10
  5 │  55 │    10
  6 │  55 │    10
  7 │  55 │    10
  8 │  55 │    10
  9 │  55 │    10
 10 │  55 │    10
                  </code></pre>
                </div>
                <aside class="notes"></aside>
            </section>

            <section>
                <h3>Rows mode</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">ROWS</span> BETWEEN
               UNBOUNDED PRECEDING
               AND CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   1 │     1
  2 │   3 │     2
  3 │   6 │     3
  4 │  10 │     4
  5 │  15 │     5
  6 │  21 │     6
  7 │  28 │     7
  8 │  36 │     8
  9 │  45 │     9
 10 │  55 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>literal CURRENT ROW</p>
                </aside>
            </section>

            <section>
                <h3>Limit Current Range</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">RANGE</span> CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │  55 │    10
  2 │  55 │    10
  3 │  55 │    10
  4 │  55 │    10
  5 │  55 │    10
  6 │  55 │    10
  7 │  55 │    10
  8 │  55 │    10
  9 │  55 │    10
 10 │  55 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>use <em>frame_start</em> only</p>
                </aside>
            </section>

            <section>
                <h3>Limit Current Row</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">ROWS</span> CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   1 │     1
  2 │   2 │     1
  3 │   3 │     1
  4 │   4 │     1
  5 │   5 │     1
  6 │   6 │     1
  7 │   7 │     1
  8 │   8 │     1
  9 │   9 │     1
 10 │  10 │     1
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>literal CURRENT ROW</p>
                </aside>
            </section>

<!--
            <section>
                <h3>Example Following</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (ROWS between CURRENT ROW
                  and <span class="emphasize">1 FOLLOWING</span>);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   3 │     2
  2 │   5 │     2
  3 │   7 │     2
  4 │   9 │     2
  5 │  11 │     2
  6 │  13 │     2
  7 │  15 │     2
  8 │  17 │     2
  9 │  19 │     2
 10 │  10 │     1
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>Missing row is not null, it is IGNORED</p>
                  <p>Same for PRECEDING</p>
                </aside>
            </section>
-->

          </section>

          <section data-transition="slide">
            <section>
                <h2>Window with ORDER BY</h2>
                <aside class="notes">
                  <p>until now FRAME without ordering and partitioning</p>
                </aside>
            </section>

            <section data-transistion="fade">
                <h3>Simple order by</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(a) OVER w
  FROM c
WINDOW w AS (<span class="emphasize">ORDER BY</span> a);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   1 │     1
  2 │   3 │     2
  3 │   6 │     3
  4 │  10 │     4
  5 │  15 │     5
  6 │  21 │     6
  7 │  28 │     7
  8 │  36 │     8
  9 │  45 │     9
 10 │  55 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <h3>Order by with defaults</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(a) OVER w
  FROM c
WINDOW w AS (
 ORDER BY a
 <span class="emphasize">RANGE</span> between UNBOUNDED PRECEDING
       and CURRENT ROW
);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   1 │     1
  2 │   3 │     2
  3 │   6 │     3
  4 │  10 │     4
  5 │  15 │     5
  6 │  21 │     6
  7 │  28 │     7
  8 │  36 │     8
  9 │  45 │     9
 10 │  55 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <h3>Order by Current Row</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM c
WINDOW w AS (ORDER BY a
             RANGE <span class="emphasize">CURRENT ROW</span>);
                  </code></pre>
                  <pre><code>
 a  │ sum │ count
────┼─────┼───────
  1 │   1 │     1
  2 │   2 │     1
  3 │   3 │     1
  4 │   4 │     1
  5 │   5 │     1
  6 │   6 │     1
  7 │   7 │     1
  8 │   8 │     1
  9 │   9 │     1
 10 │  10 │     1
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>ORDER BY current row are the peers</p>
                </aside>
            </section>

            <section>
                <h3>Use Duplicates</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT * FROM d;
                  </code></pre>
                  <pre><code>
 a
───
 1
 1
 2
 2
 3
 3
 4
 4
 5
 5
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <h3>Empty Window Specification</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS ();
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │  30 │    10
 1 │  30 │    10
 2 │  30 │    10
 2 │  30 │    10
 3 │  30 │    10
 3 │  30 │    10
 4 │  30 │    10
 4 │  30 │    10
 5 │  30 │    10
 5 │  30 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>only the sum changed</p>
                </aside>
            </section>

            <section>
                <h3>Order By with Duplicates</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (<SPAN CLASS="emphasize">ORDER BY</span> a);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   2 │     2
 1 │   2 │     2
 2 │   6 │     4
 2 │   6 │     4
 3 │  12 │     6
 3 │  12 │     6
 4 │  20 │     8
 4 │  20 │     8
 5 │  30 │    10
 5 │  30 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <h3>Remember the Defaults</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (
       ORDER BY a
       <span class="emphasize">RANGE</span> BETWEEN UNBOUNDED PRECEDING
             AND CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   2 │     2
 1 │   2 │     2
 2 │   6 │     4
 2 │   6 │     4
 3 │  12 │     6
 3 │  12 │     6
 4 │  20 │     8
 4 │  20 │     8
 5 │  30 │    10
 5 │  30 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>order value defines peers</li>
                    <li>current row for peers</li>
                    <li>rolling sum for groups</li>
                    <li>aggregate equal for peers</li>
                  </ul>
                </aside>
            </section>

            <section>
                <h3>Rows with Duplicates</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (
       ORDER BY a
       <span class="emphasize">ROWS</span> BETWEEN UNBOUNDED PRECEDING
            AND CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   1 │     1
 1 │   2 │     2
 2 │   4 │     3
 2 │   6 │     4
 3 │   9 │     5
 3 │  12 │     6
 4 │  16 │     7
 4 │  20 │     8
 5 │  25 │     9
 5 │  30 │    10
                  </code></pre>
                </div>
                <aside class="notes">
                  <p>Test data vs. Production data</p>
                </aside>
            </section>

            <section>
                <h3>Current Row for RANGE</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (ORDER BY a
             RANGE <span class="emphasize">CURRENT ROW</span>);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   2 │     2
 1 │   2 │     2
 2 │   4 │     2
 2 │   4 │     2
 3 │   6 │     2
 3 │   6 │     2
 4 │   8 │     2
 4 │   8 │     2
 5 │  10 │     2
 5 │  10 │     2
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <h3>Current Row for ROWS mode</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (ORDER BY a
             <span class="emphasize">ROWS</span> CURRENT ROW);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   1 │     1
 1 │   1 │     1
 2 │   2 │     1
 2 │   2 │     1
 3 │   3 │     1
 3 │   3 │     1
 4 │   4 │     1
 4 │   4 │     1
 5 │   5 │     1
 5 │   5 │     1
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <p>Exercise: List the date and netamount per order together with the
                  accumulating daily revenue.</p>
                <div class="">
                  <pre class="sli fragment"><code>
 orderdate  | netamount | daily_revenue
------------+-----------+---------------
 2004-01-01 |    124.77 |       4428.15
 2004-01-01 |     48.50 |       4428.15
 2004-01-01 |     65.43 |       4428.15
 2004-01-02 |    183.09 |       9154.52
 2004-01-02 |    227.24 |       9154.52
 2004-01-02 |    131.74 |       9154.52                  </code></pre>
                  <pre class="sli fragment"><code data-noescape>
SELECT orderdate,
       netamount,
       SUM(netamount) OVER (ORDER BY orderdate)
       AS daily_revenue
  FROM orders
 LIMIT 100;
                  </code></pre>
                </div>
                <aside class="notes">
                </aside>
            </section>
          </section>

          <section data-transition="slide">
            <section>
              <h2>Partition By</h2>
            </section>

            <section>
                <h3>Simple Partition By</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (<span class="emphasize">PARTITION BY a</span>);
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
 1 │   2 │     2
 1 │   2 │     2
 2 │   4 │     2
 2 │   4 │     2
 3 │   6 │     2
 3 │   6 │     2
 4 │   8 │     2
 4 │   8 │     2
 5 │  10 │     2
 5 │  10 │     2
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>same as RANGE CURRENT ROW</li>
                    <li>partition matches window frame</li>
                  </ul>
                </aside>
            </section>

            <section>
                <h3>Split into 2 partitions</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (PARTITION BY <span class="emphasize">a < 3</span>)
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
<div style="background-color:#81DAF5;display:inline-block;"> 1 │   6 │     4
 1 │   6 │     4
 2 │   6 │     4
 2 │   6 │     4</div>
 3 │  24 │     6
 3 │  24 │     6
 4 │  24 │     6
 4 │  24 │     6
 5 │  24 │     6
 5 │  24 │     6
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>simple expression allowed, neither names nor number of
                    columns allowed</li>
                    <li>partition with duplicates</li>
                    <li>missing ORDER BY: frame defaults to partition</li>
                  </ul>
                </aside>
            </section>

            <section>
                <h3>Partition and Group by</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (
       PARTITION BY a < 3
       <span class="emphasize">ORDER BY a</span>
)
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
<div style="background-color:#81DAF5;display:inline-block;"> 1 │   2 │     2
 1 │   2 │     2
 2 │   6 │     4
 2 │   6 │     4</div>
 3 │   6 │     2
 3 │   6 │     2
 4 │  14 │     4
 4 │  14 │     4
 5 │  24 │     6
 5 │  24 │     6
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li>Order by changes the frame</li>
                  </ul>
                </aside>
            </section>

            <section>
                <h3>Defaults for frame</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (
       PARTITION BY a < 3
       ORDER BY a
       <span class="emphasize">RANGE
        between UNBOUNDED PRECEDING
        and CURRENT ROW</span>
)
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
<div style="background-color:#81DAF5;display:inline-block;"> 1 │   2 │     2
 1 │   2 │     2
 2 │   6 │     4
 2 │   6 │     4</div>
 3 │   6 │     2
 3 │   6 │     2
 4 │  14 │     4
 4 │  14 │     4
 5 │  24 │     6
 5 │  24 │     6
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li></li>
                  </ul>
                </aside>
            </section>

            <section>
                <h3>Rows Mode with Partition</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a, sum(a) OVER w,
          count(*) OVER w
  FROM d
WINDOW w AS (
       PARTITION BY a < 3
       ORDER BY a
       <span class="emphasize">ROWS</span>
        between UNBOUNDED PRECEDING
        and CURRENT ROW
)
                  </code></pre>
                  <pre><code>
 a │ sum │ count
───┼─────┼───────
<div style="background-color:#81DAF5;display:inline-block;"> 1 │   1 │     1
 1 │   2 │     2
 2 │   4 │     3
 2 │   6 │     4</div>
 3 │   3 │     1
 3 │   6 │     2
 4 │  10 │     3
 4 │  14 │     4
 5 │  19 │     5
 5 │  24 │     6
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li></li>
                  </ul>
                </aside>
            </section>

            <section>
              <p>Exercise: List the order with their customerid, country, netamount and the
              netamount per country.</p>
                <div class="fragment">
                  <pre><code data-noescape>
SELECT customerid, country, netamount,
       sum(netamount) OVER cty
  FROM customers
  JOIN orders USING (customerid)
WINDOW cty AS (PARTITION BY country)
                  </code></pre>
                  <pre><code>
 customerid │ country │ netamount │    sum
────────────┼─────────┼───────────┼────────────
          2 │ US      │      5.08 │ 1172676.73
          3 │ US      │     39.06 │ 1172676.73
          6 │ US      │    323.30 │ 1172676.73
          7 │ US      │    341.44 │ 1172676.73
         11 │ US      │    285.39 │ 1172676.73
         12 │ US      │    350.87 │ 1172676.73
         13 │ US      │     83.31 │ 1172676.73
         13 │ US      │    227.45 │ 1172676.73
                  </code></pre>
                </div>
                <aside class="notes"></aside>
            </section>

            <section>
                <h3>Access other rows</h3>
                <div class="sli">
                  <pre><code data-noescape>
SELECT a,
       LAG(a) over w,
       LEAD(a) over w
  FROM d
WINDOW w AS ()
 ORDER BY a
                  </code></pre>
                  <pre><code>
 a | lag | lead
---+-----+------
 1 |     |    1
 1 |   1 |    2
 2 |   1 |    2
 2 |   2 |    3
 3 |   2 |    3
 3 |   3 |    4
 4 |   3 |    4
 4 |   4 |    5
 5 |   4 |    5
 5 |   5 |
                  </code></pre>
                </div>
                <aside class="notes">
                  <ul>
                    <li></li>
                  </ul>
                </aside>
            </section>

            <section>
              <p>Exercise: Calculate the time span between subsequent orders in
              days for
              the customer 19887.</p>
                <div class="fragment">
                  <pre><code data-noescape>
SELECT customerid,
       orderdate - lag(orderdate) OVER c AS diff
  FROM orders
 WHERE customerid = 19887
WINDOW c AS (PARTITION BY customerid ORDER BY orderdate);
                  </code></pre>
                  <pre><code>
 customerid | diff
------------+------
      19887 |
      19887 |   68
      19887 |   37
      19887 |   62
      19887 |   72
      19887 |   44
                  </code></pre>
                </div>
                <aside class="notes"></aside>
            </section>

            <section>
              <p>Exercise: List the customer for every order with their country,
              netamount per order, netamount per customer and the
              netamount per country.</p>
                <div class="fragment">
                  <pre><code data-noescape>
SELECT customerid, country, netamount,
       sum(netamount) OVER custcty AS per_customer,
       sum(netamount) OVER cty AS per_country
  FROM customers
  JOIN orders USING (customerid)
WINDOW cty AS (PARTITION BY country),
       custcty AS (<span class="emphasize">cty</span> order by customerid range current row);
                  </code></pre>
                  <pre><code>
 customerid │ country │ netamount │  per_customer │ per_country
────────────┼─────────┼───────────┼───────────────┼───────────────
         12 │ US      │    350.87 │        350.87 │ 1172676.73
         13 │ US      │     83.31 │        310.76 │ 1172676.73
         13 │ US      │    227.45 │        310.76 │ 1172676.73
                  </code></pre>
                </div>
                <aside class="notes"></aside>
            </section>
          </section>

          <section>

            <h2>Further steps</h2>
            <ul>
              <li>Functions</li>
              <li>GROUPS</li>
              <li>Different meanings of <code><em>offset</em></code></li>
            </ul>
            <aside class="notes">
              <h1>Key take away</h1>
            </aside>
          </section>

        </div>
    </div>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/headjs/1.0.3/head.load.js"></script> -->
    <script src="js/head.load.1.0.3.js"></script>
    <script src="js/reveal.js"></script>
    <script>
      Reveal.initialize({
      //enables simple reload during development
      history: true,
      viewDistance: 3,
      transition: 'fade',
      /* disable blinking cursors */
      controlsTutorial: false,
      slideNumber: 'c',
      dependencies: [
      { src: 'plugin/notes/notes.js', async: true },
      ]});
    </script>
</body>
</html>
